<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Taste Haven - Advanced Admin Panel</title>
    <link rel="icon" href="assets/favicon.ico" type="image/x-icon" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <style>
        /* Custom scrollbar for webkit browsers */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f8e9; /* Light green background for track */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #2e7d32; /* Primary green for thumb */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #005005; /* Darker green for thumb hover */
        }
        .sidebar-item.active {
            background-color: #2e7d32; /* Primary Green */
            color: white;
        }
        .sidebar-item.active ion-icon {
            color: white;
        }
        .modal {
            display: none; /* Hidden by default */
        }
        .modal.open {
            display: flex; /* Show when open */
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        /* Project Specific Colors */
        :root {
            --th-primary: #2e7d32;
            --th-primary-dark: #005005;
            --th-primary-light: #60ad5e;
            --th-secondary: #ff8f00; /* Orange */
            --th-light-bg: #f1f8e9;
            --th-surface: #ffffff;
            --th-text: #212121;
            --th-text-secondary: #757575;
            --th-divider: #e0e0e0;
            --th-error: #d32f2f; /* Added for login error consistency */
        }
        .bg-th-primary { background-color: var(--th-primary); }
        .text-th-primary { color: var(--th-primary); }
        .border-th-primary { border-color: var(--th-primary); }
        .hover\:bg-th-primary-dark:hover { background-color: var(--th-primary-dark); }
        
        .bg-th-secondary { background-color: var(--th-secondary); }
        .text-th-secondary { color: var(--th-secondary); }
        .border-th-secondary { border-color: var(--th-secondary); }
        .hover\:bg-th-secondary-dark:hover { background-color: #c56e00; } /* Darker orange */

        .bg-th-light-bg { background-color: var(--th-light-bg); }

        /* Table Management Styles */
        .table-management-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 1rem;
        }
        .table-status-card {
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            border: 1px solid var(--th-divider, #e0e0e0);
        }
        .table-status-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .table-status-card.available {
            background-color: #e8f5e9; /* Light Green */
            color: var(--th-primary-dark);
            border-left: 5px solid var(--th-primary);
        }
        .table-status-card.occupied {
            background-color: #ffebee; /* Light Red */
            color: #c62828; /* Dark Red */
            border-left: 5px solid #d32f2f;
        }
        .table-status-card ion-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            display: block;
        }
        .table-status-card .status-text {
            font-size: 0.8rem;
            font-weight: 500;
            margin-top: 0.25rem;
        }

        /* Cash approval button style */
        .btn-approve-cash {
            background-color: var(--th-secondary);
            color: white;
            padding: 0.5rem 1rem; /* Increased padding for better visibility */
            border-radius: 0.375rem; /* Tailwind's rounded-md */
            font-size: 0.875rem; /* Tailwind's text-sm */
            font-weight: 500; /* Tailwind's font-medium */
            border: none;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        .btn-approve-cash:hover {
            background-color: #c56e00; /* Darker orange */
        }
        .btn-approve-cash:disabled {
            background-color: #fdba74; /* Lighter orange for disabled state */
            cursor: not-allowed;
        }
        /* Login Form Styles */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--th-light-bg);
        }
        .login-box {
            background-color: var(--th-surface);
            padding: 2.5rem; 
            border-radius: 0.75rem; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); 
            width: 100%;
            max-width: 400px; 
        }
        .login-title {
            font-size: 1.875rem; 
            font-weight: 600; 
            color: var(--th-primary-dark);
            text-align: center;
            margin-bottom: 2rem;
        }
        .login-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--th-divider);
            border-radius: 0.5rem; 
            margin-bottom: 1.25rem;
            font-size: 1rem;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .login-input:focus {
            border-color: var(--th-primary);
            box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.2); 
            outline: none;
        }
        .login-button {
            width: 100%;
            padding: 0.875rem 1rem;
            background-color: var(--th-primary);
            color: white;
            border: none;
            border-radius: 0.5rem; 
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        .login-button:hover {
            background-color: var(--th-primary-dark);
        }
        .login-error {
            color: var(--th-error); /* Using defined error color */
            font-size: 0.875rem;
            text-align: center;
            margin-top: 1rem;
            min-height: 1.25rem; 
        }

    </style>
</head>
<body class="bg-th-light-bg font-sans antialiased">
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="text-white text-xl">Loading...</div>
    </div>

    <div id="toast-notification" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-md hidden z-[100]">
        <p id="toast-message-content">Notification</p> </div>

    <div id="login-section" class="login-container">
        <div class="login-box">
            <h2 class="login-title">Taste Haven Admin</h2>
            <div>
                <input type="text" id="adminId" placeholder="Admin ID" class="login-input">
                <input type="password" id="adminPassword" placeholder="Password" class="login-input">
                <button id="loginBtn" class="login-button">Login</button>
                <p id="login-error-message" class="login-error"></p>
            </div>
        </div>
    </div>

    <div id="admin-panel-main" class="flex h-screen bg-gray-200 hidden">
        <div class="w-64 bg-gray-800 text-white flex flex-col">
            <div class="px-6 py-4 border-b border-gray-700 bg-th-primary">
                <h1 class="text-2xl font-semibold text-white">Taste Haven</h1>
                <p class="text-sm text-green-100">Admin Panel</p>
            </div>
            <nav class="flex-1 overflow-y-auto bg-gray-800">
                <a href="#" class="sidebar-item flex items-center px-6 py-3 hover:bg-gray-700 transition duration-150" data-tab="dashboard">
                    <ion-icon name="grid-outline" class="mr-3 text-lg text-gray-400"></ion-icon> Dashboard
                </a>
                <a href="#" class="sidebar-item flex items-center px-6 py-3 hover:bg-gray-700 transition duration-150" data-tab="orders">
                    <ion-icon name="receipt-outline" class="mr-3 text-lg text-gray-400"></ion-icon> Order Management
                </a>
                <a href="#" class="sidebar-item flex items-center px-6 py-3 hover:bg-gray-700 transition duration-150" data-tab="menu">
                    <ion-icon name="restaurant-outline" class="mr-3 text-lg text-gray-400"></ion-icon> Menu Management
                </a>
                <a href="#" class="sidebar-item flex items-center px-6 py-3 hover:bg-gray-700 transition duration-150" data-tab="tables">
                    <ion-icon name="tablet-landscape-outline" class="mr-3 text-lg text-gray-400"></ion-icon> Table Management
                </a>
                <a href="#" class="sidebar-item flex items-center px-6 py-3 hover:bg-gray-700 transition duration-150" data-tab="specials">
                    <ion-icon name="sparkles-outline" class="mr-3 text-lg text-gray-400"></ion-icon> Specials & Offers
                </a>
                <a href="#" class="sidebar-item flex items-center px-6 py-3 hover:bg-gray-700 transition duration-150" data-tab="chefs">
                    <ion-icon name="people-circle-outline" class="mr-3 text-lg text-gray-400"></ion-icon> Chef Management
                </a>
                <a href="#" class="sidebar-item flex items-center px-6 py-3 hover:bg-gray-700 transition duration-150" data-tab="customers">
                    <ion-icon name="people-outline" class="mr-3 text-lg text-gray-400"></ion-icon> Customer Management
                </a>
                <a href="#" class="sidebar-item flex items-center px-6 py-3 hover:bg-gray-700 transition duration-150" data-tab="payment-approval">
                    <ion-icon name="cash-outline" class="mr-3 text-lg text-gray-400"></ion-icon> Payment Approval
                </a>
                <a href="#" class="sidebar-item flex items-center px-6 py-3 hover:bg-gray-700 transition duration-150" data-tab="analytics">
                    <ion-icon name="analytics-outline" class="mr-3 text-lg text-gray-400"></ion-icon> Analytics
                </a>
                 <a href="#" id="adminLogoutBtn" class="sidebar-item flex items-center px-6 py-3 hover:bg-red-600 transition duration-150 mt-auto border-t border-gray-700">
                    <ion-icon name="log-out-outline" class="mr-3 text-lg text-gray-400"></ion-icon> Logout
                </a>
            </nav>
        </div>

        <main class="flex-1 p-6 overflow-y-auto">
            <div id="dashboard-section" class="content-section">
                <h2 class="text-3xl font-semibold text-gray-700 mb-6">Dashboard</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-lg font-semibold text-gray-600">Total Orders</h3>
                        <p id="stats-total-orders" class="text-3xl font-bold text-th-primary">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-lg font-semibold text-gray-600">Today's Revenue</h3>
                        <p id="stats-todays-revenue" class="text-3xl font-bold text-green-500">₹0</p>
                    </div>
                     <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-lg font-semibold text-gray-600">Active Tables</h3>
                        <p id="stats-active-tables" class="text-3xl font-bold text-th-secondary">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-lg font-semibold text-gray-600">New Customers (Month)</h3>
                        <p id="stats-new-customers" class="text-3xl font-bold text-yellow-500">0</p>
                    </div>
                </div>

                <div class="mb-6">
                    <h3 class="text-2xl font-semibold text-gray-700 mb-4">Live Kitchen Activity</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div class="bg-yellow-100 p-4 rounded-lg shadow">
                            <h4 class="font-semibold text-yellow-700">Accepted Orders</h4>
                            <p id="kitchen-accepted-count" class="text-2xl font-bold text-yellow-800">0</p>
                        </div>
                        <div class="bg-blue-100 p-4 rounded-lg shadow">
                            <h4 class="font-semibold text-blue-700">Preparing Orders</h4>
                            <p id="kitchen-preparing-count" class="text-2xl font-bold text-blue-800">0</p>
                        </div>
                        <div class="bg-purple-100 p-4 rounded-lg shadow">
                            <h4 class="font-semibold text-purple-700">Ready for Pickup</h4>
                            <p id="kitchen-ready-count" class="text-2xl font-bold text-purple-800">0</p>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-md">
                        <h4 class="text-lg font-semibold text-gray-700 mb-2">Currently Active Orders:</h4>
                        <div id="dashboard-active-orders-list" class="overflow-x-auto max-h-60 text-sm">
                            <p class="text-gray-500">Loading active orders...</p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4">Recent Orders (Last 5)</h3>
                        <div id="dashboard-recent-orders" class="overflow-x-auto max-h-96">
                            <p class="text-gray-500">Loading recent orders...</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4">Sales Overview (Last 7 Days)</h3>
                        <div class="chart-container">
                            <canvas id="salesChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div id="orders-section" class="content-section hidden">
                <h2 class="text-3xl font-semibold text-gray-700 mb-6">Order Management</h2>
                <div class="mb-4 flex space-x-4">
                    <select id="order-status-filter" class="p-2 border rounded-md shadow-sm focus:border-green-500 focus:ring-green-500">
                        <option value="all">All Statuses</option>
                        <option value="pending_payment">Pending Cash Approval</option>
                        <option value="order placed">Placed</option>
                        <option value="accepted">Accepted</option>
                        <option value="preparing">Preparing</option>
                        <option value="ready">Ready</option>
                        <option value="completed">Completed</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                    <input type="date" id="order-date-filter" class="p-2 border rounded-md shadow-sm focus:border-green-500 focus:ring-green-500" />
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Order ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Table</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Items</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Payment</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status/Action</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table-body" class="bg-white divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="menu-section" class="content-section hidden">
                <h2 class="text-3xl font-semibold text-gray-700 mb-6">Menu Management</h2>
                <button id="add-menu-item-btn" class="mb-6 bg-th-primary hover:bg-th-primary-dark text-white font-semibold py-2 px-4 rounded-lg shadow-md flex items-center">
                    <ion-icon name="add-circle-outline" class="mr-2"></ion-icon> Add New Item
                </button>
                <div class="mb-4">
                    <label for="menu-category-filter" class="block text-sm font-medium text-gray-700">Filter by Category:</label>
                    <select id="menu-category-filter" class="mt-1 block w-full md:w-1/3 p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                        <option value="all">All Categories</option>
                        <option value="starters">Starters</option>
                        <option value="main">Main Course</option>
                        <option value="desserts">Desserts</option>
                        <option value="drinks">Drinks</option>
                    </select>
                </div>
                <div id="menu-items-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    </div>
            </div>
            
            <div id="tables-section" class="content-section hidden">
                <h2 class="text-3xl font-semibold text-gray-700 mb-6">Table Management</h2>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div id="table-management-grid" class="table-management-grid">
                        <p class="text-gray-500 col-span-full text-center py-4">Loading table statuses...</p>
                    </div>
                </div>
            </div>

            <div id="specials-section" class="content-section hidden">
                <h2 class="text-3xl font-semibold text-gray-700 mb-6">Specials & Offers</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4">Today's Specials</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="chefSpecial" class="block text-sm font-medium text-gray-700">Chef's Special Dish</label>
                                <input type="text" id="chefSpecial" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:border-green-500 focus:ring-green-500" placeholder="e.g., Paneer Lababdar with Garlic Naan">
                            </div>
                            <div>
                                <label for="dailyOffer" class="block text-sm font-medium text-gray-700">Special Offer for Today</label>
                                <input type="text" id="dailyOffer" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:border-green-500 focus:ring-green-500" placeholder="e.g., 20% off on all desserts!">
                            </div>
                            <button onclick="window.saveDailySpecials()" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md">Save Today's Specials</button>
                        </div>
                        <div class="mt-6">
                            <h4 class="text-md font-semibold text-gray-600">Current Special:</h4>
                            <p id="current-chef-special" class="text-gray-800"></p>
                            <h4 class="text-md font-semibold text-gray-600 mt-2">Current Offer:</h4>
                            <p id="current-daily-offer" class="text-gray-800"></p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4">Festival/Campaign Offers</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="offerTitle" class="block text-sm font-medium text-gray-700">Campaign Title</label>
                                <input type="text" id="offerTitle" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:border-orange-500 focus:ring-orange-500" placeholder="e.g., Diwali Dhamaka">
                            </div>
                            <div>
                                <label for="offerDetail" class="block text-sm font-medium text-gray-700">Discount Details</label>
                                <input type="text" id="offerDetail" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:border-orange-500 focus:ring-orange-500" placeholder="e.g., Flat 30% off on Main Course">
                            </div>
                            <button onclick="window.saveFestivalOffer()" class="w-full bg-th-secondary hover:bg-th-secondary-dark text-white font-semibold py-2 px-4 rounded-lg shadow-md">Post Campaign Offer</button>
                        </div>
                        <div class="mt-6">
                            <h4 class="text-md font-semibold text-gray-600">Active Campaign Offers:</h4>
                            <ul id="festival-offers-list" class="list-disc list-inside text-gray-800 max-h-60 overflow-y-auto">
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div id="chefs-section" class="content-section hidden">
                <h2 class="text-3xl font-semibold text-gray-700 mb-6">Chef Management</h2>
                 <button id="add-chef-btn" class="mb-6 bg-th-primary hover:bg-th-primary-dark text-white font-semibold py-2 px-4 rounded-lg shadow-md flex items-center">
                    <ion-icon name="person-add-outline" class="mr-2"></ion-icon> Add New Chef
                </button>
                <div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Chef ID/Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="chefs-table-body" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="customers-section" class="content-section hidden">
                <h2 class="text-3xl font-semibold text-gray-700 mb-6">Customer Management</h2>
                <div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Joined Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Orders</th>
                            </tr>
                        </thead>
                        <tbody id="customers-table-body" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            </div>
            <div id="payment-approval-section" class="content-section hidden">
                 <h2 class="text-3xl font-semibold text-gray-700 mb-6">Cash Payment Approval</h2>
                 <div id="cash-approval-list" class="space-y-4">
                  <p class="text-gray-500">Loading pending cash payments...</p>
                  </div>
                </div>


            <div id="analytics-section" class="content-section hidden">
                <h2 class="text-3xl font-semibold text-gray-700 mb-6">Analytics</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4">Revenue by Day (Last 30 Days)</h3>
                         <div class="chart-container">
                            <canvas id="revenueByDayChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4">Most Popular Items</h3>
                        <div class="chart-container">
                            <canvas id="popularItemsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="menu-item-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full items-center justify-center z-30">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md mx-auto">
            <h3 id="menu-item-modal-title" class="text-2xl font-semibold mb-6 text-gray-800">Add New Menu Item</h3>
            <form id="menu-item-form">
                <input type="hidden" id="edit-menu-item-id">
                <input type="hidden" id="edit-menu-item-category-original">
                <div class="mb-4">
                    <label for="menu-item-name" class="block text-sm font-medium text-gray-700">Item Name</label>
                    <input type="text" id="menu-item-name" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:border-green-500 focus:ring-green-500" required>
                </div>
                <div class="mb-4">
                    <label for="menu-item-desc" class="block text-sm font-medium text-gray-700">Description</label>
                    <textarea id="menu-item-desc" rows="3" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:border-green-500 focus:ring-green-500"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="menu-item-price" class="block text-sm font-medium text-gray-700">Price (₹)</label>
                        <input type="number" id="menu-item-price" step="0.01" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:border-green-500 focus:ring-green-500" required>
                    </div>
                    <div>
                        <label for="menu-item-category" class="block text-sm font-medium text-gray-700">Category</label>
                        <select id="menu-item-category" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:border-green-500 focus:ring-green-500" required>
                            <option value="starters">Starters</option>
                            <option value="main">Main Course</option>
                            <option value="desserts">Desserts</option>
                            <option value="drinks">Drinks</option>
                        </select>
                    </div>
                </div>
                 <div class="mb-4">
                    <label for="menu-item-icon" class="block text-sm font-medium text-gray-700">Icon Name (Ionicons)</label>
                    <input type="text" id="menu-item-icon" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:border-green-500 focus:ring-green-500" placeholder="e.g., fast-food-outline">
                </div>
                <div class="mb-4">
                    <label for="menu-item-image-url" class="block text-sm font-medium text-gray-700">Image URL (Optional)</label>
                    <input type="url" id="menu-item-image-url" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:border-green-500 focus:ring-green-500" placeholder="https://placehold.co/600x400/2e7d32/white?text=Food+Item">
                </div>
                <div class="mb-4">
                    <label for="menu-item-special" class="block text-sm font-medium text-gray-700">Special Tag (Optional)</label>
                    <input type="text" id="menu-item-special" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:border-green-500 focus:ring-green-500" placeholder="e.g., Bestseller, New">
                </div>
                <div class="mb-6">
                    <label class="flex items-center">
                        <input type="checkbox" id="menu-item-available" class="form-checkbox h-5 w-5 text-green-600 focus:ring-green-500" checked>
                        <span class="ml-2 text-sm text-gray-700">Available for ordering</span>
                    </label>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-menu-item-modal" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-md">Cancel</button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-th-primary hover:bg-th-primary-dark rounded-md">Save Item</button>
                </div>
            </form>
        </div>
    </div>

    <div id="chef-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full items-center justify-center z-30">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md mx-auto">
            <h3 id="chef-modal-title" class="text-2xl font-semibold mb-6 text-gray-800">Add New Chef</h3>
            <form id="chef-form">
                <input type="hidden" id="edit-chef-id">
                <div class="mb-4">
                    <label for="chef-name" class="block text-sm font-medium text-gray-700">Chef Name</label>
                    <input type="text" id="chef-name" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:border-green-500 focus:ring-green-500" required>
                </div>
                <div class="mb-4">
                    <label for="chef-email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="chef-email" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:border-green-500 focus:ring-green-500" required>
                </div>
                <div class="mb-4">
                    <label for="chef-password" class="block text-sm font-medium text-gray-700">Password (leave blank if not changing)</label>
                    <input type="password" id="chef-password" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:border-green-500 focus:ring-green-500">
                </div>
                <div class="mb-6">
                    <label class="flex items-center">
                        <input type="checkbox" id="chef-enabled" class="form-checkbox h-5 w-5 text-green-600 focus:ring-green-500" checked>
                        <span class="ml-2 text-sm text-gray-700">Enable Chef Account</span>
                    </label>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-chef-modal" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-md">Cancel</button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-th-primary hover:bg-th-primary-dark rounded-md">Save Chef</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="order-details-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full items-center justify-center z-30">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg mx-auto">
            <h3 class="text-2xl font-semibold mb-4 text-gray-800">Order Details</h3>
            <div id="order-details-content" class="text-sm text-gray-700 space-y-2">
            </div>
            <div class="mt-6 flex justify-end">
                <button type="button" id="close-order-details-modal" class="px-4 py-2 text-sm font-medium text-white bg-th-primary hover:bg-th-primary-dark rounded-md">Close</button>
            </div>
        </div>
    </div>


    <script>
        // Firebase Initialization Variables
        let firebaseConfig = {};
        let db, auth, firestoreDb; 
        let salesChartInstance = null;
        let revenueByDayChartInstance = null;
        let popularItemsChartInstance = null;
        let ordersRefListener = null; 
        let occupiedTablesListener = null; 

        // Admin Credentials (IMPORTANT: Replace with a secure method in a production environment)
        const ADMIN_ID = "admin";
        const ADMIN_PASSWORD = "tastenow"; // CHANGE THIS PASSWORD!

        // DOM Elements for Login
        const loginSection = document.getElementById('login-section');
        const adminPanelMain = document.getElementById('admin-panel-main');
        const adminIdInput = document.getElementById('adminId');
        const adminPasswordInput = document.getElementById('adminPassword');
        const loginBtn = document.getElementById('loginBtn');
        const loginErrorMessage = document.getElementById('login-error-message');

        // Utility to show loading overlay
        function showLoading(isLoading) {
            const overlay = document.getElementById('loading-overlay');
            if (isLoading) {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }
        window.showLoading = showLoading; // Make it globally accessible
        
        // Utility to show toast notifications
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast-notification');
            const toastMessageEl = document.getElementById('toast-message-content'); // Using updated ID
            toastMessageEl.textContent = message;

            toast.classList.remove('bg-green-500', 'bg-red-500', 'bg-yellow-500', 'bg-orange-500', 'text-black', 'bg-green-600', 'bg-red-600', 'bg-blue-500');
            toast.classList.add('text-white'); 

            if (type === 'success') toast.classList.add('bg-green-600'); 
            else if (type === 'error') toast.classList.add('bg-red-600'); 
            else if (type === 'info') toast.classList.add('bg-blue-500');
            else toast.classList.add('bg-orange-500'); // Default for other types

            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }
        window.showToast = showToast; // Make it globally accessible

        // Function to handle admin login
        function handleAdminLogin() {
            const enteredId = adminIdInput.value.trim();
            const enteredPassword = adminPasswordInput.value;
            loginErrorMessage.textContent = ''; // Clear previous errors

            if (enteredId === ADMIN_ID && enteredPassword === ADMIN_PASSWORD) {
                sessionStorage.setItem('isAdminLoggedInTasteHaven', 'true'); // Store login state
                loginSection.classList.add('hidden');
                adminPanelMain.classList.remove('hidden');
                fetchFirebaseConfigAndInitializeApp(); // Initialize Firebase and app after successful login
            } else {
                loginErrorMessage.textContent = 'Invalid Admin ID or Password.';
                showToast("Login Failed: Invalid credentials.", "error");
            }
        }

        // Function to handle admin logout
        function handleAdminLogout() {
            // Detach Firebase listeners to prevent errors when logged out
            if (ordersRefListener && db) db.ref('orders').off('value', ordersRefListener);
            if (occupiedTablesListener && db) db.ref('occupied_tables').off('value', occupiedTablesListener);
            ordersRefListener = null; // Reset listener variable
            occupiedTablesListener = null; // Reset listener variable
            
            if (auth && auth.currentUser) { // Check if auth is initialized and a user is signed in
                auth.signOut().then(() => {
                    showToast("Logged out successfully from Firebase.", "success");
                }).catch(error => {
                    console.error("Error signing out from Firebase:", error);
                    showToast("Error logging out from Firebase: " + error.message, "error");
                });
            }

            sessionStorage.removeItem('isAdminLoggedInTasteHaven'); // Clear login state
            adminPanelMain.classList.add('hidden');
            loginSection.classList.remove('hidden');
            adminIdInput.value = ''; // Clear input fields
            adminPasswordInput.value = '';
            loginErrorMessage.textContent = ''; 
            showToast("You have been logged out.", "info");
        }
        
        // Check login status on page load
        function checkLoginStatus() {
            if (sessionStorage.getItem('isAdminLoggedInTasteHaven') === 'true') {
                loginSection.classList.add('hidden');
                adminPanelMain.classList.remove('hidden');
                fetchFirebaseConfigAndInitializeApp(); // Initialize if already logged in
            } else {
                loginSection.classList.remove('hidden');
                adminPanelMain.classList.add('hidden');
                showLoading(false); // Ensure loading overlay is hidden if not logged in
            }
        }

        // Fetch Firebase config and initialize the app (only after successful custom login)
        function fetchFirebaseConfigAndInitializeApp() {
            showLoading(true);
            fetch('firebaseConfig.json') 
                .then(res => {
                    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}, Failed to fetch firebaseConfig.json. Make sure the file exists and is accessible.`);
                    return res.json();
                })
                .then(config => {
                    firebaseConfig = config;
                    if (!firebase.apps.length) { // Prevent re-initialization if already initialized
                        firebase.initializeApp(firebaseConfig);
                    }
                    db = firebase.database(); 
                    auth = firebase.auth(); 
                    firestoreDb = firebase.firestore(); 
                    
                    // Attempt anonymous sign-in for Firebase services if needed for rules, etc.
                    // This runs *after* the custom admin login has been verified.
                    if (!auth.currentUser) {
                        auth.signInAnonymously().then(() => { 
                            // console.log("Firebase services connected (anonymously).");
                            // showToast("Firebase services connected (anonymously).", "info"); // Optional: can be noisy
                            initializeAppLogic(); // Initialize main app logic after Firebase is ready
                        }).catch(error => {
                            console.error("Firebase anonymous sign-in failed:", error);
                            showToast("Firebase connection issue. Some features might be limited.", "warning");
                            initializeAppLogic(); // Proceed even if anonymous sign-in fails for some basic functionalities
                        });
                    } else {
                        // console.log("Firebase user already signed in:", auth.currentUser.uid);
                        initializeAppLogic(); // If already signed in (e.g. from a previous session)
                    }
                })
                .catch(error => {
                    console.error("CRITICAL Error loading Firebase config:", error);
                    showToast("CRITICAL: Error loading Firebase config. Admin panel cannot function.", "error");
                    showLoading(false);
                    // Display a more prominent error on the page if config fails
                    const mainContentArea = document.querySelector('main') || document.body;
                    mainContentArea.innerHTML = `<div class="flex items-center justify-center h-screen text-2xl bg-th-light-bg text-red-600 p-8 text-center">Failed to load Firebase configuration.<br>Please ensure 'firebaseConfig.json' is present in the root directory and is correctly formatted.<br>The admin panel cannot operate without it.<br><br>Details: ${error.message}</div>`;
                    loginSection.classList.add('hidden'); // Hide login form if Firebase is broken
                    adminPanelMain.classList.add('hidden'); // Hide admin panel
                });
        }

        // Main app initialization logic (called after login and Firebase setup)
        function initializeAppLogic() {
            setupTabNavigation();
            // Load dashboard data by default when app logic initializes
            loadDataForTab('dashboard'); // This will also call listenToLiveOrders if on dashboard
            
            // Event listeners for modals and forms
            document.getElementById('add-menu-item-btn').addEventListener('click', () => openMenuItemModal());
            document.getElementById('cancel-menu-item-modal').addEventListener('click', closeMenuItemModal);
            document.getElementById('menu-item-form').addEventListener('submit', handleMenuItemSubmit);
            document.getElementById('menu-category-filter').addEventListener('change', (e) => loadMenuItems(e.target.value));

            document.getElementById('add-chef-btn').addEventListener('click', () => openChefModal());
            document.getElementById('cancel-chef-modal').addEventListener('click', closeChefModal);
            document.getElementById('chef-form').addEventListener('submit', handleChefSubmit);

            document.getElementById('close-order-details-modal').addEventListener('click', () => {
                document.getElementById('order-details-modal').classList.remove('open');
            });
            
            const adminLogoutButton = document.getElementById('adminLogoutBtn');
            if (adminLogoutButton) { // Ensure button exists
                adminLogoutButton.removeEventListener('click', handleAdminLogout); // Remove if already attached
                adminLogoutButton.addEventListener('click', handleAdminLogout);
            }
            showLoading(false); // Hide loading overlay once app logic is initialized
        }


        document.addEventListener('DOMContentLoaded', () => {
            checkLoginStatus(); // Check login status first

            // Attach login button event listener
            if (loginBtn) { // Check if element exists
                loginBtn.addEventListener('click', handleAdminLogin);
            }
            // Allow login with Enter key in password field
            if(adminPasswordInput) { // Check if element exists
                adminPasswordInput.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        handleAdminLogin();
                    }
                });
            }
            // Allow login with Enter key in admin ID field (optional, can also move focus)
            if(adminIdInput) { // Check if element exists
                 adminIdInput.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        // handleAdminLogin(); // Or focus next field: adminPasswordInput.focus();
                        adminPasswordInput.focus(); // Move focus to password field
                    }
                });
            }
        });

        function setupTabNavigation() {
            const sidebarItems = document.querySelectorAll('.sidebar-item');
            const contentSections = document.querySelectorAll('.content-section');

            sidebarItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (item.id === 'adminLogoutBtn') return; // Logout is handled separately
                    const targetTab = item.dataset.tab;
                    
                    sidebarItems.forEach(i => i.classList.remove('active', 'bg-th-primary', 'text-white'));
                    item.classList.add('active', 'bg-th-primary', 'text-white');
                    
                    contentSections.forEach(section => section.classList.add('hidden'));
                    const activeSection = document.getElementById(`${targetTab}-section`);
                    if (activeSection) {
                        activeSection.classList.remove('hidden');
                        loadDataForTab(targetTab); // Load data specific to the clicked tab
                    }
                });
            });
            // Ensure dashboard is activated by default if no other tab is selected
            const activeSidebarItem = document.querySelector('.sidebar-item.active');
            if (!activeSidebarItem) {
                const dashboardLink = document.querySelector('.sidebar-item[data-tab="dashboard"]');
                if (dashboardLink) dashboardLink.click(); 
            }
        }

        function loadDataForTab(tabId) {
            showLoading(true);
            // Detach occupied_tables listener if not on the tables tab to save resources
            if (occupiedTablesListener && db && tabId !== 'tables') {
                db.ref('occupied_tables').off('value', occupiedTablesListener);
                occupiedTablesListener = null;
            }
             // Detach orders listener if not on dashboard or orders tab
            if (ordersRefListener && db && tabId !== 'dashboard' && tabId !== 'orders') {
                db.ref('orders').off('value', ordersRefListener);
                ordersRefListener = null;
            }


            switch (tabId) {
                case 'payment-approval':
                   loadPendingCashOrders();
                   break;

                case 'dashboard':
                    loadDashboardData(); 
                    if (!ordersRefListener && db) listenToLiveOrders(); // Re-attach if needed
                    break;
                case 'orders':
                    loadOrders();
                    const statusFilter = document.getElementById('order-status-filter');
                    const dateFilter = document.getElementById('order-date-filter');
                    // Ensure event listeners for filters are attached only once
                    if (statusFilter && !statusFilter.dataset.listenerAttached) {
                        statusFilter.addEventListener('change', loadOrders);
                        statusFilter.dataset.listenerAttached = 'true';
                    }
                    if (dateFilter && !dateFilter.dataset.listenerAttached) {
                        dateFilter.addEventListener('change', loadOrders);
                        dateFilter.dataset.listenerAttached = 'true';
                    }
                    if (!ordersRefListener && db) listenToLiveOrders(); // Re-attach if needed
                    break;
                case 'menu': loadMenuItems(); break;
                case 'tables': loadTableManagement(); break; // This function will attach its own listener
                case 'specials': loadSpecialsAndOffers(); break;
                case 'chefs': loadChefs(); break;
                case 'customers': loadCustomers(); break;
                case 'analytics': loadAnalyticsData(); break;
            }
            setTimeout(() => showLoading(false), 350); // Slightly increased delay for data rendering
        }

        function listenToLiveOrders() {
            if (!db) {
                console.warn("Database not initialized. Cannot listen to live orders.");
                return;
            }
            const ordersNodeRef = db.ref('orders');
            // If a listener already exists, ensure it's the correct one or detach before reattaching
            if (ordersRefListener) {
                ordersNodeRef.off('value', ordersRefListener);
            }
            
            ordersRefListener = ordersNodeRef.orderByChild('timestamp').on('value', (snapshot) => {
                const ordersData = snapshot.val() || {};
                
                // Update dashboard components if dashboard is visible
                const dashboardSection = document.getElementById('dashboard-section');
                if (dashboardSection && !dashboardSection.classList.contains('hidden')) {
                    updateLiveKitchenStatus(ordersData); // For kitchen counts
                    populateDashboardRecentOrders(Object.values(ordersData).sort((a,b) => b.timestamp - a.timestamp)); // For recent orders list
                }
                
                // Update orders table if orders tab is visible
                const ordersSection = document.getElementById('orders-section');
                if (ordersSection && !ordersSection.classList.contains('hidden')) {
                    loadOrders(); // This will re-fetch and re-render based on current filters
                }
            }, (error) => {
                console.error("Firebase listener error on 'orders':", error);
                showToast("Error listening to live order updates.", "error");
            });
        }

        function updateLiveKitchenStatus(ordersData) {
            let acceptedCount = 0, preparingCount = 0, readyCount = 0;
            const activeOrdersForDashboard = []; // Orders actively being processed
            for (const orderId in ordersData) {
                const order = { id: orderId, ...ordersData[orderId] };
                // Only count orders that are past payment approval for kitchen status
                if (order.status === 'pending_payment') continue; 

                if (order.status === 'accepted') { acceptedCount++; activeOrdersForDashboard.push(order); }
                else if (order.status === 'preparing') { preparingCount++; activeOrdersForDashboard.push(order); }
                else if (order.status === 'ready') { readyCount++; activeOrdersForDashboard.push(order); }
            }
            const kitchenAcceptedEl = document.getElementById('kitchen-accepted-count');
            const kitchenPreparingEl = document.getElementById('kitchen-preparing-count');
            const kitchenReadyEl = document.getElementById('kitchen-ready-count');
            if(kitchenAcceptedEl) kitchenAcceptedEl.textContent = acceptedCount;
            if(kitchenPreparingEl) kitchenPreparingEl.textContent = preparingCount;
            if(kitchenReadyEl) kitchenReadyEl.textContent = readyCount;

            const activeOrdersListDiv = document.getElementById('dashboard-active-orders-list');
            if (!activeOrdersListDiv) return; // Element might not exist if dashboard isn't rendered

            activeOrdersListDiv.innerHTML = ''; 
            if (activeOrdersForDashboard.length === 0) {
                activeOrdersListDiv.innerHTML = '<p class="text-gray-500">No orders currently in kitchen (excluding pending cash approvals).</p>';
            } else {
                const table = document.createElement('table');
                table.className = "min-w-full divide-y divide-gray-200";
                table.innerHTML = `<thead class="bg-gray-50"><tr><th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">ID</th><th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Table</th><th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th></tr></thead><tbody class="bg-white divide-y divide-gray-200"></tbody>`;
                const tbody = table.querySelector('tbody');
                // Sort active orders by timestamp for display
                activeOrdersForDashboard.sort((a,b) => a.timestamp - b.timestamp).forEach(order => { 
                    const row = tbody.insertRow();
                    row.innerHTML = `<td class="px-3 py-2">${order.id.substring(0,8)}...</td><td class="px-3 py-2">${order.table || 'N/A'}</td><td class="px-3 py-2"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusColorClass(order.status)}">${order.status}</span></td>`;
                });
                activeOrdersListDiv.appendChild(table);
            }
        }

        async function loadDashboardData() {
    if (!db) { console.warn("DB not ready for dashboard data"); return; }

    try {
        const ordersSnapshot = await db.ref('orders').once('value');
        const orders = ordersSnapshot.val() || {};
        const ordersArray = Object.values(orders);
        
        const today = new Date();
        const todayISO = today.toISOString().slice(0, 10);
        let todaysRevenue = 0;
        const salesLast7Days = Array(7).fill(0);

        ordersArray.forEach(order => {
            if (!order.timestamp || isNaN(order.timestamp)) return;
            const orderDate = new Date(order.timestamp);
            const orderDateISO = orderDate.toISOString().slice(0, 10);

            if (order.status === 'completed' && !isNaN(order.total_amount)) {
                const total = parseFloat(order.total_amount);
                if (orderDateISO === todayISO) {
                    todaysRevenue += total;
                }
                const diffDays = Math.floor((today - orderDate) / (1000 * 60 * 60 * 24));
                if (diffDays >= 0 && diffDays < 7) {
                    salesLast7Days[6 - diffDays] += total;
                }
            }
        });

        document.getElementById('stats-total-orders').textContent = ordersArray.length;
        document.getElementById('stats-todays-revenue').textContent = `₹${todaysRevenue.toFixed(2)}`;

        // Chart draw करें
        const salesChartCtx = document.getElementById('salesChart')?.getContext('2d');
        if (salesChartCtx) {
            const labelsLast7Days = Array(7).fill(0).map((_, i) => {
                const d = new Date();
                d.setDate(d.getDate() - (6 - i));
                return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });

            if (salesChartInstance) salesChartInstance.destroy();
            salesChartInstance = new Chart(salesChartCtx, {
                type: 'line',
                data: {
                    labels: labelsLast7Days,
                    datasets: [{
                        label: 'Revenue (₹)',
                        data: salesLast7Days,
                        borderColor: 'var(--th-primary)',
                        backgroundColor: 'rgba(46, 125, 50, 0.1)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }
        const snapshot = await firestoreDb.collection('users').get();
        let newCustomerCount = 0;
        snapshot.forEach(doc => {
            const data = doc.data();
            if (data.createdAt && data.createdAt.toDate) {
                const joinDate = data.createdAt.toDate();
                const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                if (joinDate >= monthStart) newCustomerCount++;
            }
        });

        document.getElementById('stats-new-customers').textContent = newCustomerCount;

        const occupiedSnapshot = await db.ref('occupied_tables').once('value');
        const occupied = occupiedSnapshot.val() || {};
        const activeCount = Object.values(occupied).filter(val => val === true).length;
        document.getElementById('stats-active-tables').textContent = activeCount;


    } catch (error) {
        console.error("Error loading dashboard data:", error);
        showToast("Error loading dashboard data.", "error");
    }
}


        function populateDashboardRecentOrders(sortedOrdersArray) {
            const recentOrdersContainer = document.getElementById('dashboard-recent-orders');
            if (!recentOrdersContainer) return; // Element might not exist
            recentOrdersContainer.innerHTML = ''; 
            const recent = sortedOrdersArray.slice(0, 5); // Get top 5 recent
            if (recent.length === 0) { recentOrdersContainer.innerHTML = '<p class="text-gray-500">No recent orders.</p>'; return; }
            
            const table = document.createElement('table');
            table.className = "min-w-full divide-y divide-gray-200 text-sm";
            table.innerHTML = `<thead class="bg-gray-50"><tr><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Table</th><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Total</th><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Payment</th><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th></tr></thead><tbody class="bg-white divide-y divide-gray-200"></tbody>`;
            const tbody = table.querySelector('tbody');
            recent.forEach(order => {
                const row = tbody.insertRow();
                let paymentDisplay = order.payment_method || 'N/A';
                if (order.status === 'pending_payment' && (order.payment_method || '').toLowerCase() === 'cash') {
                    paymentDisplay = `Cash (Pending Approval)`;
                } else if (order.payment_status === 'cash_approved') {
                     paymentDisplay = `Cash (Approved)`;
                } else if (order.status === 'pending_payment') {
                    paymentDisplay += ` (Pending Conf.)`;
                }


                row.innerHTML = `
                    <td class="px-4 py-2">${order.table||'N/A'}</td>
                    <td class="px-4 py-2">₹${parseFloat(order.total_amount||0).toFixed(2)}</td>
                    <td class="px-4 py-2 text-xs">${paymentDisplay}</td>
                    <td class="px-4 py-2"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusColorClass(order.status)}">${order.status}</span></td>`;
            });
            recentOrdersContainer.appendChild(table);
        }
        
        function getStatusColorClass(status) {
            status = (status || '').toLowerCase();
            if (status === 'completed') return 'bg-green-100 text-green-800';
            if (status === 'pending_payment') return 'bg-orange-100 text-orange-800'; 
            if (status === 'order placed') return 'bg-yellow-100 text-yellow-800';
            if (status === 'accepted') return 'bg-blue-100 text-blue-800'; // Changed for better distinction
            if (status === 'preparing') return 'bg-indigo-100 text-indigo-800'; // Changed for better distinction
            if (status === 'ready') return 'bg-purple-100 text-purple-800';
            if (status === 'cancelled') return 'bg-red-100 text-red-800';
            return 'bg-gray-100 text-gray-800'; // Default
        }

        async function loadOrders() {
            if (!db) { console.warn("DB not ready for loading orders."); showLoading(false); return; }
            showLoading(true);
            try {
                const statusFilterVal = document.getElementById('order-status-filter').value;
                const dateFilterVal = document.getElementById('order-date-filter').value;
   
                
                // Fetch all orders once for filtering. Listener will handle live updates.
                const ordersRef = db.ref('orders');
                const snapshot = await ordersRef.once('value'); // Fetch data once for current rendering
                let orders = snapshot.val() ? Object.entries(snapshot.val()).map(([id, data]) => ({ id, ...data })) : [];

                // Apply filters
                if (statusFilterVal !== 'all') {
                    orders = orders.filter(order => order.status === statusFilterVal);
                }
                if (dateFilterVal) {
                    orders = orders.filter(order => new Date(order.timestamp).toISOString().slice(0, 10) === dateFilterVal);
                }
                orders.sort((a,b) => b.timestamp - a.timestamp); // Sort by newest first

                const tableBody = document.getElementById('orders-table-body');
                tableBody.innerHTML = ''; 
                if (orders.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="8" class="text-center py-4">No orders found matching criteria.</td></tr>';
                    showLoading(false); return;
                    document.getElementById('order-date-filter').value = '';
                }

                orders.forEach(order => {
                    const row = tableBody.insertRow();
                    const itemsSummary = (order.items || []).map(item => `${item.name} (x${item.quantity || 1})`).join(', ');
                    let statusCellContent = '';
                    let paymentMethodDisplay = order.payment_method || 'N/A';

                    // Specific handling for cash payment approval
                    if (order.status === 'pending_payment' && (order.payment_method || '').toLowerCase() === 'cash') {
                        statusCellContent = `<button class="btn-approve-cash" onclick="window.approveCashOrder('${order.id}')">Approve Cash</button>`;
                        paymentMethodDisplay = `Cash (Pending Approval)`;
                    } 
                    // Handling for already approved cash orders
                    else if (order.payment_status === 'cash_approved' && (order.payment_method || '').toLowerCase() === 'cash') {
                        paymentMethodDisplay = `Cash (Approved)`;
                        // Show normal status dropdown, pre-select current status (likely 'order placed' after approval)
                        statusCellContent = `
                            <select class="order-status-dropdown p-1 border rounded-md text-sm focus:border-green-500 focus:ring-green-500" data-order-id="${order.id}">
                                <option value="order placed" ${order.status === 'order placed' ? 'selected' : ''}>Placed</option>
                                <option value="accepted" ${order.status === 'accepted' ? 'selected' : ''}>Accepted</option>
                                <option value="preparing" ${order.status === 'preparing' ? 'selected' : ''}>Preparing</option>
                                <option value="ready" ${order.status === 'ready' ? 'selected' : ''}>Ready</option>
                                <option value="completed" ${order.status === 'completed' ? 'selected' : ''}>Completed</option>
                                <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                            </select>`;
                    } 
                    // Handling for other statuses including online pending payments
                    else {
                        const isPendingOnlinePayment = order.status === 'pending_payment'; // Online payment failed or pending
                        statusCellContent = `
                            <select class="order-status-dropdown p-1 border rounded-md text-sm focus:border-green-500 focus:ring-green-500" data-order-id="${order.id}" ${isPendingOnlinePayment ? 'disabled title="Online payment pending confirmation or failed"' : ''}>
                                ${isPendingOnlinePayment ? `<option value="pending_payment" selected>Pending Confirmation</option>` : ''}
                                <option value="order placed" ${order.status === 'order placed' && !isPendingOnlinePayment ? 'selected' : ''} ${isPendingOnlinePayment ? 'hidden' : ''}>Placed</option>
                                <option value="accepted" ${order.status === 'accepted' && !isPendingOnlinePayment ? 'selected' : ''} ${isPendingOnlinePayment ? 'hidden' : ''}>Accepted</option>
                                <option value="preparing" ${order.status === 'preparing' && !isPendingOnlinePayment ? 'selected' : ''} ${isPendingOnlinePayment ? 'hidden' : ''}>Preparing</option>
                                <option value="ready" ${order.status === 'ready' && !isPendingOnlinePayment ? 'selected' : ''} ${isPendingOnlinePayment ? 'hidden' : ''}>Ready</option>
                                <option value="completed" ${order.status === 'completed' && !isPendingOnlinePayment ? 'selected' : ''} ${isPendingOnlinePayment ? 'hidden' : ''}>Completed</option>
                                <option value="cancelled" ${order.status === 'cancelled' && !isPendingOnlinePayment ? 'selected' : ''} ${isPendingOnlinePayment ? 'hidden' : ''}>Cancelled</option>
                            </select>
                        `;
                         if (isPendingOnlinePayment) paymentMethodDisplay += ` (Pending Conf.)`;
                    }

                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${order.id.substring(0,8)}...</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.table || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 max-w-xs truncate" title="${itemsSummary}">${itemsSummary || 'No items listed'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">₹${parseFloat(order.total_amount || 0).toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${paymentMethodDisplay}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">${statusCellContent}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(order.timestamp).toLocaleString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="window.viewOrderDetails('${order.id}')" class="text-green-600 hover:text-green-900 mr-2">View</button>
                            <button onclick="window.deleteOrder('${order.id}')" class="text-red-600 hover:text-red-900">Delete</button>
                        </td>
                    `;
                });
                
                // Re-attach event listeners for newly created dropdowns
                document.querySelectorAll('.order-status-dropdown').forEach(dropdown => {
                    dropdown.removeEventListener('change', handleOrderStatusChange); // Remove old to prevent duplicates
                    dropdown.addEventListener('change', handleOrderStatusChange);
                });
            } catch (error) {
                console.error("Error loading orders:", error);
                showToast("Error loading orders. " + error.message, "error");
                document.getElementById('orders-table-body').innerHTML = '<tr><td colspan="8" class="text-center py-4">Error loading orders. Check console for details.</td></tr>';
            }
            showLoading(false);
        }
        window.loadOrders = loadOrders; 
        
        // Handler function for status dropdown changes
        function handleOrderStatusChange(event) {
            window.updateOrderStatus(event.target.dataset.orderId, event.target.value);
        }
        async function approveCashOrder(orderId) {
    if (!db || !auth) {
        showToast("Firebase not ready. Please wait and try again.", "error");
        return;
    }

    if (!confirm(`Are you sure you want to approve cash payment for order ${orderId.substring(0,8)}? This will set the status to 'order placed'.`)) return;

    showLoading(true);

    try {
        // Step 1: Fetch the full order object
        const snapshot = await db.ref(`orders/${orderId}`).once('value');
        const order = snapshot.val();

        if (!order) {
            showToast("Order not found in database.", "error");
            showLoading(false);
            return;
        }

        // Step 2: Determine admin identity
        const adminUserIdentifier = auth.currentUser ? auth.currentUser.email : (sessionStorage.getItem('isAdminLoggedInTasteHaven') === 'true' ? ADMIN_ID : 'system_admin');

        // Step 3: Approve the cash order
        await db.ref(`orders/${orderId}`).update({
            status: 'order placed',
            payment_status: 'cash_approved',
            cash_approved_at: firebase.database.ServerValue.TIMESTAMP,
            cash_approved_by: adminUserIdentifier
        });

        // Step 4: Optionally notify chef via WebSocket
        if (typeof ws !== 'undefined' && ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({
                type: "new_order",
                orderId: orderId,
                table: order.table || "N/A"
            }));
        } else {
            console.warn("WebSocket not available. Skipping notify.");
        }

        showToast(`Cash for order ${orderId.substring(0,8)} approved successfully.`, "success");

    } catch (error) {
        console.error("Error approving cash order:", error);
        showToast("Error approving cash order: " + error.message, "error");
    }

    showLoading(false);
}

        window.approveCashOrder = approveCashOrder; 

        async function updateOrderStatus(orderId, newStatus) {
            if (!db) { showToast("Database not ready. Cannot update order status.", "error"); return; }
            showLoading(true);
            try {
                await db.ref(`orders/${orderId}/status`).set(newStatus);
                // Optionally, log who changed the status if more detailed auditing is needed
                // const adminUserIdentifier = auth.currentUser ? auth.currentUser.email : (sessionStorage.getItem('isAdminLoggedInTasteHaven') === 'true' ? ADMIN_ID : 'system_admin');
                // await db.ref(`orders/${orderId}/status_history`).push({ 
                //     status: newStatus, 
                //     changed_at: firebase.database.ServerValue.TIMESTAMP,
                //     changed_by: adminUserIdentifier
                // });
                showToast(`Order ${orderId.substring(0,8)} status updated to ${newStatus}.`, "success");
                // The Firebase listener will refresh the orders table automatically.
            } catch (error) { 
                console.error("Error updating order status:", error); 
                showToast("Error updating order status: " + error.message, "error"); 
            }
            showLoading(false);
        }
        window.updateOrderStatus = updateOrderStatus;
        
        async function viewOrderDetails(orderId) {
            if (!db) { showToast("Database not ready. Cannot view order details.", "error"); return; }
            showLoading(true);
            try {
                const orderSnapshot = await db.ref(`orders/${orderId}`).once('value');
                const order = orderSnapshot.val();
                if (!order) { 
                    showToast("Order not found.", "error"); 
                    showLoading(false); 
                    return; 
                }
                const contentDiv = document.getElementById('order-details-content');
                let itemsHtml = (order.items || []).map(item => `<li>${item.name || 'Unknown Item'} (x${item.quantity || 1}) - ₹${(item.price && typeof item.price === 'number') ? item.price.toFixed(2) : 'N/A'} each</li>`).join('');
                
                let detailsHtml = `
                    <p><strong>ID:</strong> ${orderId}</p>
                    <p><strong>Table:</strong> ${order.table || 'N/A'}</p>
                    <p><strong>Timestamp:</strong> ${order.timestamp ? new Date(order.timestamp).toLocaleString() : 'N/A'}</p>
                    <p><strong>Payment Method:</strong> ${order.payment_method || 'N/A'}</p>
                    <p><strong>Status:</strong> ${order.status || 'N/A'}</p>`;

                if (order.payment_status) {
                    detailsHtml += `<p><strong>Payment Status:</strong> ${order.payment_status}</p>`;
                }
                if ((order.payment_method || '').toLowerCase() === 'cash' && order.cash_approved_at) {
                    detailsHtml += `<p><strong>Cash Approved At:</strong> ${order.cash_approved_at ? new Date(order.cash_approved_at).toLocaleString() : 'N/A'}</p>`;
                    detailsHtml += `<p><strong>Cash Approved By:</strong> ${order.cash_approved_by || 'N/A'}</p>`;
                }
                if (order.payment_id) { // For online payments
                     detailsHtml += `<p><strong>Online Payment ID:</strong> ${order.payment_id}</p>`;
                }

                detailsHtml += `
                    <p><strong>Total Amount:</strong> ₹${(order.total_amount && typeof order.total_amount === 'number') ? parseFloat(order.total_amount).toFixed(2) : '0.00'}</p>
                    <p><strong>Items:</strong></p>
                    <ul class="list-disc list-inside ml-4">${itemsHtml || '<li>No items listed.</li>'}</ul>`;
                
                if (order.user_email) { 
                     detailsHtml += `<p><strong>Customer Email:</strong> ${order.user_email}</p>`;
                }


                contentDiv.innerHTML = detailsHtml;
                document.getElementById('order-details-modal').classList.add('open');
            } catch (error) { 
                console.error("Error fetching order details:", error); 
                showToast("Error fetching order details: " + error.message, "error"); 
            }
            showLoading(false);
        }
        window.viewOrderDetails = viewOrderDetails;

        async function deleteOrder(orderId) {
            if (!db) { showToast("Database not ready. Cannot delete order.", "error"); return; }
            if (confirm(`Are you sure you want to delete order ${orderId.substring(0,8)}? This action cannot be undone.`)) {
                showLoading(true);
                try { 
                    await db.ref(`orders/${orderId}`).remove(); 
                    showToast(`Order ${orderId.substring(0,8)} deleted successfully.`, "success"); 
                    // The Firebase listener will refresh the orders table automatically.
                }
                catch (error) { 
                    console.error("Error deleting order:", error); 
                    showToast("Error deleting order: " + error.message, "error"); 
                }
                showLoading(false);
            }
        }
        window.deleteOrder = deleteOrder;

        function loadPendingCashOrders() {
          const container = document.getElementById('cash-approval-list');
          container.innerHTML = '<p class="text-gray-500">Loading pending cash payments...</p>';

          db.ref('orders').orderByChild('status').equalTo('pending_payment').once('value', snapshot => {
            const orders = snapshot.val();
            container.innerHTML = '';

         if (!orders) {
           container.innerHTML = '<p class="text-gray-500">No pending cash payments found.</p>';
           return;
        }

        Object.entries(orders).forEach(([orderId, order]) => {
          if (order.payment_method !== 'cash') return;

          const card = document.createElement('div');
          card.className = 'bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded shadow';
          card.innerHTML = `
            <div class="flex justify-between items-center">
              <div>
                <h3 class="text-lg font-semibold text-yellow-800">Order ID: ${orderId}</h3>
                <p>Table: ${order.table || 'N/A'}</p>
                <p>Payment Status: <strong>${order.payment_status}</strong></p>
              </div>
              <button onclick="approveCashOrder('${orderId}')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded shadow">
                Approve Cash
              </button>
            </div>
          `;
          container.appendChild(card);
        });
      });
    }


        // --- Menu Management Functions (No changes from previous, ensure they are complete) ---
        const menuItemModal = document.getElementById('menu-item-modal');
        const menuItemForm = document.getElementById('menu-item-form');
        function openMenuItemModal(item = null, category = null, itemId = null) {
            menuItemForm.reset();
            document.getElementById('edit-menu-item-id').value = '';
            document.getElementById('edit-menu-item-category-original').value = '';
            if (item && category && itemId) { 
                document.getElementById('menu-item-modal-title').textContent = 'Edit Menu Item';
                document.getElementById('edit-menu-item-id').value = itemId;
                document.getElementById('edit-menu-item-category-original').value = category;
                document.getElementById('menu-item-name').value = item.name;
                document.getElementById('menu-item-desc').value = item.description || '';
                document.getElementById('menu-item-price').value = item.price;
                document.getElementById('menu-item-category').value = category;
                document.getElementById('menu-item-icon').value = item.icon || '';
                document.getElementById('menu-item-image-url').value = item.imageUrl || '';
                document.getElementById('menu-item-special').value = item.specialTag || '';
                document.getElementById('menu-item-available').checked = item.available !== false; 
            } else { 
                document.getElementById('menu-item-modal-title').textContent = 'Add New Menu Item';
            }
            menuItemModal.classList.add('open');
        }
        window.openMenuItemModal = openMenuItemModal;

        function closeMenuItemModal() { menuItemModal.classList.remove('open'); }
        window.closeMenuItemModal = closeMenuItemModal;

        async function handleMenuItemSubmit(event) {
            event.preventDefault(); 
            if (!db) { showToast("Database not ready.", "error"); return; }
            showLoading(true);
            const itemId = document.getElementById('edit-menu-item-id').value;
            const originalCategory = document.getElementById('edit-menu-item-category-original').value;
            const name = document.getElementById('menu-item-name').value;
            const description = document.getElementById('menu-item-desc').value;
            const price = parseFloat(document.getElementById('menu-item-price').value);
            const category = document.getElementById('menu-item-category').value;
            const icon = document.getElementById('menu-item-icon').value || 'restaurant-outline';
            const imageUrl = document.getElementById('menu-item-image-url').value;
            const specialTag = document.getElementById('menu-item-special').value;
            const available = document.getElementById('menu-item-available').checked;
            if (!name || isNaN(price) || !category) { showToast("Name, Price, and Category are required.", "error"); showLoading(false); return; }
            const menuItemData = { name, description, price, category, icon, imageUrl, specialTag, available, lastUpdated: firebase.database.ServerValue.TIMESTAMP };
            try {
                if (itemId && originalCategory) { 
                    if (originalCategory !== category) {
                        await db.ref(`menu/${originalCategory}/${itemId}`).remove();
                        await db.ref(`menu/${category}/${itemId}`).set(menuItemData);
                    } else { await db.ref(`menu/${category}/${itemId}`).update(menuItemData); }
                    showToast("Menu item updated successfully!", "success");
                } else { 
                    await db.ref(`menu/${category}`).push().set(menuItemData);
                    showToast("Menu item added successfully!", "success");
                }
                closeMenuItemModal(); 
                loadMenuItems(document.getElementById('menu-category-filter').value); 
                sendMenuUpdateToWebSocket(); 
            } catch (error) { console.error("Error saving menu item:", error); showToast("Error saving menu item: " + error.message, "error"); }
            showLoading(false);
        }
        window.handleMenuItemSubmit = handleMenuItemSubmit;

        async function loadMenuItems(filterCategory = 'all') {
            if (!db) { showToast("Database not ready.", "error"); return; }
            showLoading(true);
            try {
                const menuSnapshot = await db.ref('menu').once('value');
                const menuData = menuSnapshot.val() || {};
                const grid = document.getElementById('menu-items-grid');
                grid.innerHTML = ''; 
                let itemsDisplayed = 0;
                for (const categoryKey in menuData) { // Renamed 'category' to 'categoryKey' to avoid conflict
                    if (filterCategory !== 'all' && categoryKey !== filterCategory) continue;
                    for (const itemId in menuData[categoryKey]) {
                        const item = menuData[categoryKey][itemId]; itemsDisplayed++;
                        const card = document.createElement('div');
                        card.className = `bg-white p-4 rounded-lg shadow-md border ${item.available !== false ? 'border-transparent' : 'border-red-300 bg-red-50'}`;
                        card.innerHTML = `
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="text-lg font-semibold text-gray-800">${item.name} ${item.available===false?'<span class="text-xs text-red-500">(Unavailable)</span>':''}</h4>
                                <ion-icon name="${item.icon||'restaurant-outline'}" class="text-2xl text-gray-500"></ion-icon>
                            </div>
                            ${item.imageUrl?`<img src="${item.imageUrl}" alt="${item.name}" class="w-full h-32 object-cover rounded-md mb-2" onerror="this.onerror=null; this.src='https://placehold.co/600x400/cccccc/ffffff?text=Image+Error'; this.alt='Image load error';">`:''}
                            <p class="text-sm text-gray-600 mb-1 h-10 overflow-hidden" title="${item.description || ''}">${item.description||'No description'}</p>
                            <p class="text-md font-bold text-green-600 mb-2">₹${(item.price && typeof item.price === 'number') ? item.price.toFixed(2) : '0.00'}</p>
                            <p class="text-xs text-gray-500 mb-1">Category: ${categoryKey}</p>
                            ${item.specialTag?`<p class="text-xs text-th-secondary font-semibold mb-3">Tag: ${item.specialTag}</p>`:'<div class="mb-3 h-[18px]"></div>'}
                            <div class="flex justify-end space-x-2 mt-auto">
                                <button onclick="window.toggleMenuItemAvailability('${categoryKey}','${itemId}',${item.available!==false})" class="text-sm ${item.available!==false?'bg-yellow-500 hover:bg-yellow-600':'bg-green-500 hover:bg-green-600'} text-white py-1 px-3 rounded-md">${item.available!==false?'Make Unavail.':'Make Avail.'}</button>
                                <button onclick="window.editMenuItemPrompt('${categoryKey}','${itemId}')" class="text-sm bg-blue-500 hover:bg-blue-600 text-white py-1 px-3 rounded-md">Edit</button>
                                <button onclick="window.deleteMenuItem('${categoryKey}','${itemId}')" class="text-sm bg-red-500 hover:bg-red-600 text-white py-1 px-3 rounded-md">Delete</button>
                            </div>`;
                        grid.appendChild(card);
                    }
                }
                if(itemsDisplayed === 0) grid.innerHTML = `<p class="text-gray-500 col-span-full text-center py-4">No menu items found for this category.</p>`;
            } catch (error) { 
                console.error("Error loading menu items:", error); 
                showToast("Error loading menu items.", "error"); 
                document.getElementById('menu-items-grid').innerHTML = `<p class="text-gray-500 col-span-full text-center py-4">Error loading menu items.</p>`; 
            }
            showLoading(false);
        }
        window.loadMenuItems = loadMenuItems;
        
        async function editMenuItemPrompt(category, itemId) { 
            if (!db) { showToast("Database not ready.", "error"); return; }
            const itemSnapshot = await db.ref(`menu/${category}/${itemId}`).once('value');
            const item = itemSnapshot.val();
            if (item) openMenuItemModal(item, category, itemId); else showToast("Item not found.", "error");
        }
        window.editMenuItemPrompt = editMenuItemPrompt;

        async function deleteMenuItem(category, itemId) { 
            if (!db) { showToast("Database not ready.", "error"); return; }
            if (confirm(`Are you sure you want to delete this menu item? This action cannot be undone.`)) {
                showLoading(true);
                try { 
                    await db.ref(`menu/${category}/${itemId}`).remove(); 
                    showToast("Menu item deleted successfully!", "success"); 
                    loadMenuItems(document.getElementById('menu-category-filter').value); 
                    sendMenuUpdateToWebSocket(); 
                }
                catch (error) { console.error("Error deleting menu item:", error); showToast("Error deleting menu item.", "error"); }
                showLoading(false);
            }
        }
        window.deleteMenuItem = deleteMenuItem;
        
        async function toggleMenuItemAvailability(category, itemId, currentAvailability) {
            if (!db) { showToast("Database not ready.", "error"); return; }
            showLoading(true);
            try { 
                await db.ref(`menu/${category}/${itemId}/available`).set(!currentAvailability); 
                showToast(`Item availability updated successfully.`, "success"); 
                loadMenuItems(document.getElementById('menu-category-filter').value); 
                sendMenuUpdateToWebSocket(); 
            }
            catch (error) { console.error("Error updating item availability:", error); showToast("Error updating item availability.", "error"); }
            showLoading(false);
        }
        window.toggleMenuItemAvailability = toggleMenuItemAvailability;

        function sendMenuUpdateToWebSocket() {
            if (!db) return;
            try { 
                db.ref('menu_meta/last_update').set(firebase.database.ServerValue.TIMESTAMP)
                  .then(() => console.log("Menu update signal sent to Firebase."))
                  .catch(e => console.warn("Menu update signal to Firebase failed:", e)); 
            }
            catch (e) { console.warn("Failed to send menu update signal (exception):", e.message); }
        }
        window.sendMenuUpdateToWebSocket = sendMenuUpdateToWebSocket;

        // --- Table Management Functions (No changes from previous, ensure they are complete) ---
        function loadTableManagement() {
            if (!db) { showToast("Database not ready.", "error"); return; }
            showLoading(true);
            const tableGrid = document.getElementById('table-management-grid');
            tableGrid.innerHTML = '<p class="text-gray-500 col-span-full text-center py-4">Loading table statuses...</p>';
            
            if (occupiedTablesListener) db.ref('occupied_tables').off('value', occupiedTablesListener);

            occupiedTablesListener = db.ref('occupied_tables').on('value', (snapshot) => {
                const occupiedTables = snapshot.val() || {}; 
                tableGrid.innerHTML = ''; 
                const totalTables = 15; 
                for (let i = 1; i <= totalTables; i++) {
                    const tableId = String(i); 
                    const isOccupied = occupiedTables[tableId] === true;
                    const card = document.createElement('div');
                    card.className = `table-status-card ${isOccupied ? 'occupied' : 'available'}`;
                    card.dataset.tableId = tableId;
                    card.innerHTML = `
                        <ion-icon name="${isOccupied ? 'close-circle-outline' : 'checkmark-circle-outline'}"></ion-icon>
                        Table ${tableId}
                        <p class="status-text">${isOccupied ? 'Occupied' : 'Available'}</p>`;
                    card.onclick = () => window.toggleTableStatus(tableId, isOccupied);
                    tableGrid.appendChild(card);
                }
                showLoading(false);
            }, (error) => { 
                console.error("Error loading table statuses:", error); 
                showToast("Error loading table statuses.", "error"); 
                tableGrid.innerHTML = '<p class="text-red-500 col-span-full text-center py-4">Error loading table statuses.</p>'; 
                showLoading(false); 
            });
        }
        window.loadTableManagement = loadTableManagement;

        async function toggleTableStatus(tableId, currentStatus) {
            if (!db) { showToast("Database not ready.", "error"); return; }
            const newStatus = !currentStatus; 
            const actionText = newStatus ? "mark as occupied" : "mark as available";
            if (confirm(`Are you sure you want to ${actionText} Table ${tableId}?`)) {
                showLoading(true);
                try { 
                    await db.ref(`occupied_tables/${tableId}`).set(newStatus); 
                    showToast(`Table ${tableId} successfully ${newStatus ? 'marked as occupied' : 'marked as available'}.`, "success"); 
                }
                catch (error) { 
                    console.error(`Error toggling table ${tableId} status:`, error); 
                    showToast(`Failed to ${actionText} Table ${tableId}.`, "error"); 
                }
                showLoading(false); 
            }
        }
        window.toggleTableStatus = toggleTableStatus;

        // --- Specials & Offers Functions (No changes from previous, ensure they are complete) ---
        async function loadSpecialsAndOffers() { 
            if (!db) { showToast("Database not ready.", "error"); return; }
            showLoading(true);
            try {
                const specialsSnap = await db.ref('specials').once('value');
                const specials = specialsSnap.val() || {};
                document.getElementById('chefSpecial').value = specials.chefSpecial || '';
                document.getElementById('dailyOffer').value = specials.offers || ''; 
                document.getElementById('current-chef-special').textContent = specials.chefSpecial || 'Not set';
                document.getElementById('current-daily-offer').textContent = specials.offers || 'Not set';

                const festivalOffersSnap = await db.ref('festival_offers').orderByChild('timestamp').limitToLast(10).once('value'); 
                const festivalOffers = festivalOffersSnap.val() || {};
                const listUl = document.getElementById('festival-offers-list');
                listUl.innerHTML = '';
                if (Object.keys(festivalOffers).length === 0) {
                    listUl.innerHTML = '<li>No active campaign offers.</li>';
                } else {
                    Object.entries(festivalOffers).reverse().forEach(([key, offer]) => { 
                        const li = document.createElement('li');
                        li.className = "py-1 border-b border-gray-200 last:border-b-0 flex justify-between items-center";
                        li.innerHTML = `<span><strong>${offer.title}:</strong> ${offer.detail}</span>
                                        <button onclick="window.deleteFestivalOffer('${key}')" class="text-red-500 hover:text-red-700 text-xs p-1"><ion-icon name="trash-outline"></ion-icon></button>`;
                        listUl.appendChild(li);
                    });
                }
            } catch (error) { console.error("Error loading specials/offers:", error); showToast("Error loading specials and offers.", "error"); }
            showLoading(false);
        } 
        window.loadSpecialsAndOffers = loadSpecialsAndOffers;

        async function saveDailySpecials() { 
            if (!db) { showToast("Database not ready.", "error"); return; }
            showLoading(true);
            const chefSp = document.getElementById('chefSpecial').value;
            const dailyOff = document.getElementById('dailyOffer').value;
            try {
                await db.ref('specials').set({ 
                    chefSpecial: chefSp, 
                    offers: dailyOff, 
                    lastUpdated: firebase.database.ServerValue.TIMESTAMP 
                });
                showToast("Today's specials saved successfully!", "success");
                loadSpecialsAndOffers(); 
            } catch (error) { console.error("Error saving daily specials:", error); showToast("Error saving daily specials.", "error"); }
            showLoading(false);
        } 
        window.saveDailySpecials = saveDailySpecials;

        async function saveFestivalOffer() { 
            if (!db) { showToast("Database not ready.", "error"); return; }
            showLoading(true);
            const title = document.getElementById('offerTitle').value;
            const detail = document.getElementById('offerDetail').value;
            if (!title || !detail) { showToast("Campaign title and detail are required.", "error"); showLoading(false); return; }
            try {
                await db.ref('festival_offers').push({ 
                    title: title, 
                    detail: detail, 
                    timestamp: firebase.database.ServerValue.TIMESTAMP 
                });
                showToast("Campaign offer posted successfully!", "success");
                document.getElementById('offerTitle').value = ''; 
                document.getElementById('offerDetail').value = '';
                loadSpecialsAndOffers(); 
            } catch (error) { console.error("Error saving festival offer:", error); showToast("Error saving campaign offer.", "error"); }
            showLoading(false);
        } 
        window.saveFestivalOffer = saveFestivalOffer;
        
        async function deleteFestivalOffer(offerKey) {
            if (!db) { showToast("Database not ready.", "error"); return; }
            if (confirm("Are you sure you want to delete this campaign offer?")) {
                showLoading(true);
                try {
                    await db.ref(`festival_offers/${offerKey}`).remove();
                    showToast("Campaign offer deleted successfully.", "success");
                    loadSpecialsAndOffers(); 
                } catch (error) { console.error("Error deleting campaign offer:", error); showToast("Error deleting offer.", "error"); }
                showLoading(false);
            }
        }
        window.deleteFestivalOffer = deleteFestivalOffer;

        // --- Chef Management Functions (No changes from previous, ensure they are complete) ---
        const chefModal = document.getElementById('chef-modal');
        const chefForm = document.getElementById('chef-form');
        function openChefModal(chef = null, chefId = null) {
            chefForm.reset();
            document.getElementById('edit-chef-id').value = '';
            document.getElementById('chef-password').placeholder = "Create password (required for new chef)";
            document.getElementById('chef-email').readOnly = false; 
            if (chef && chefId) { 
                document.getElementById('chef-modal-title').textContent = 'Edit Chef';
                document.getElementById('edit-chef-id').value = chefId;
                document.getElementById('chef-name').value = chef.name || chefId; 
                document.getElementById('chef-email').value = chef.email;
                document.getElementById('chef-email').readOnly = true; 
                document.getElementById('chef-password').placeholder = "Leave blank to keep current password";
                document.getElementById('chef-enabled').checked = chef.enabled !== false;
            } else { 
                document.getElementById('chef-modal-title').textContent = 'Add New Chef';
            }
            chefModal.classList.add('open');
        }
        window.openChefModal = openChefModal;

        function closeChefModal() { chefModal.classList.remove('open'); }
        window.closeChefModal = closeChefModal;

        async function handleChefSubmit(event) {
            event.preventDefault(); 
            if (!db) { showToast("Database not ready.", "error"); return; }
            showLoading(true);
            const chefId = document.getElementById('edit-chef-id').value;
            const name = document.getElementById('chef-name').value;
            const email = document.getElementById('chef-email').value;
            const password = document.getElementById('chef-password').value; 
            const enabled = document.getElementById('chef-enabled').checked;
            if (!name || !email) { showToast("Chef Name and Email are required.", "error"); showLoading(false); return; }
            if (!/^\S+@\S+\.\S+$/.test(email)) { showToast("Invalid email format.", "error"); showLoading(false); return; }
            
            try {
                const chefData = { name, email, enabled, lastUpdated: firebase.database.ServerValue.TIMESTAMP };
                if (chefId) { 
                    await db.ref(`chef_users/${chefId}`).update(chefData);
                    showToast("Chef details updated successfully!", "success");
                    if (password) {
                        showToast("Password change for authenticated chef requires different handling.", "info");
                    }
                } else { 
                    if (!password) { 
                        showToast("Password is required for creating a new chef profile.", "error"); 
                        showLoading(false); return; 
                    }
                    chefData.createdAt = firebase.database.ServerValue.TIMESTAMP;
                    await db.ref('chef_users').push().set(chefData); 
                    showToast("Chef profile created in database. Actual authentication setup is separate.", "success");
                }
                closeChefModal(); 
                loadChefs(); 
            } catch (error) { 
                console.error("Error saving chef:", error); 
                showToast("Error saving chef: " + error.message, "error"); 
            }
            showLoading(false);
        }
        window.handleChefSubmit = handleChefSubmit;

        async function loadChefs() {
            if (!db) { showToast("Database not ready.", "error"); return; }
            showLoading(true);
            try {
                const chefsSnapshot = await db.ref('chef_users').once('value');
                const chefsData = chefsSnapshot.val() || {};
                const tableBody = document.getElementById('chefs-table-body');
                tableBody.innerHTML = '';
                if (Object.keys(chefsData).length === 0) { 
                    tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4">No chefs found.</td></tr>'; 
                    showLoading(false); return; 
                }
                Object.entries(chefsData).forEach(([chefId, chef]) => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${chef.name||chefId}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${chef.email}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${chef.enabled!==false?'bg-green-100 text-green-800':'bg-red-100 text-red-800'}">
                                ${chef.enabled!==false?'Enabled':'Disabled'}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="window.editChefPrompt('${chefId}')" class="text-blue-600 hover:text-blue-900 mr-2">Edit</button>
                            <button onclick="window.toggleChefStatus('${chefId}',${chef.enabled!==false})" class="text-yellow-600 hover:text-yellow-900 mr-2">${chef.enabled!==false?'Disable':'Enable'}</button>
                            <button onclick="window.deleteChef('${chefId}')" class="text-red-600 hover:text-red-900">Delete</button>
                        </td>`;
                });
            } catch (error) { 
                console.error("Error loading chefs:", error); 
                showToast("Error loading chefs.", "error"); 
                document.getElementById('chefs-table-body').innerHTML = '<tr><td colspan="4" class="text-center py-4">Error loading chefs.</td></tr>'; 
            }
            showLoading(false);
        }
        window.loadChefs = loadChefs;
        
        async function editChefPrompt(chefId) {
            if (!db) { showToast("Database not ready.", "error"); return; }
            const chefSnapshot = await db.ref(`chef_users/${chefId}`).once('value');
            const chef = chefSnapshot.val();
            if (chef) openChefModal(chef, chefId); else showToast("Chef not found.", "error");
        }
        window.editChefPrompt = editChefPrompt;

        async function toggleChefStatus(chefId, currentStatus) {
            if (!db) { showToast("Database not ready.", "error"); return; }
            showLoading(true);
            try { 
                await db.ref(`chef_users/${chefId}/enabled`).set(!currentStatus); 
                showToast(`Chef account ${!currentStatus?'enabled':'disabled'} successfully.`, "success"); 
                loadChefs(); 
            }
            catch (error) { console.error("Error toggling chef status:", error); showToast("Error toggling chef status.", "error"); }
            showLoading(false);
        }
        window.toggleChefStatus = toggleChefStatus;
        
        async function deleteChef(chefId) {
            if (!db) { showToast("Database not ready.", "error"); return; }
            if (confirm(`Are you sure you want to delete chef profile ${chefId}? This only removes the database entry, not Firebase Auth user.`)) {
                showLoading(true);
                try { 
                    await db.ref(`chef_users/${chefId}`).remove(); 
                    showToast("Chef profile deleted successfully.", "success"); 
                    loadChefs(); 
                }
                catch (error) { console.error("Error deleting chef profile:", error); showToast("Error deleting chef profile.", "error"); }
                showLoading(false);
            }
        }
        window.deleteChef = deleteChef;

        // --- Customer Management Functions (No changes from previous, ensure they are complete) ---
        async function loadCustomers() { 
            if (!firestoreDb) { 
                showToast("Firestore Database not initialized. Cannot load customers.", "error"); 
                document.getElementById('customers-table-body').innerHTML = '<tr><td colspan="5" class="text-center py-4">Firestore not available.</td></tr>'; 
                showLoading(false); 
                return; 
            }
            showLoading(true);
            try {
                const snapshot = await firestoreDb.collection('users').orderBy('createdAt', 'desc').get();
                const customersTableBody = document.getElementById('customers-table-body');
                customersTableBody.innerHTML = '';
                if (snapshot.empty) { 
                    customersTableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4">No customers found.</td></tr>'; 
                    showLoading(false); return; 
                }
                
                const customerPromises = snapshot.docs.map(async (doc) => {
                    const customer = doc.data();
                    let totalOrders = 0;
                    if (db && customer.email) { 
                        try { 
                            const ordersSnapshot = await db.ref('orders').orderByChild('user_email').equalTo(customer.email).once('value'); 
                            const ordersData = ordersSnapshot.val(); 
                            if (ordersData) totalOrders = Object.keys(ordersData).length; 
                        } catch(e){ console.warn("Could not fetch order count for customer:", customer.email, e); }
                    }
                    return { ...customer, totalOrders, firestoreDocId: doc.id };
                });

                const customersWithOrderCounts = await Promise.all(customerPromises);

                customersWithOrderCounts.forEach(customer => {
                    const row = customersTableBody.insertRow();
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${customer.name||'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${customer.email}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${customer.phone||'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${customer.createdAt && customer.createdAt.toDate ? new Date(customer.createdAt.toDate()).toLocaleDateString() : 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">${customer.totalOrders}</td>`;
                });
            } catch (error) { 
                console.error("Error loading customers:", error); 
                showToast("Error loading customers: " + error.message, "error"); 
                document.getElementById('customers-table-body').innerHTML = '<tr><td colspan="5" class="text-center py-4">Error loading customers.</td></tr>'; 
            }
            showLoading(false);
        }
        window.loadCustomers = loadCustomers;

        // --- Analytics Functions (No changes from previous, ensure they are complete) ---
        async function loadAnalyticsData() { 
            if (!db) { showToast("Database not ready for analytics.", "error"); return; }
            showLoading(true);
            try {
                const ordersSnapshot = await db.ref('orders').once('value');
                const orders = ordersSnapshot.val() || {};
                const ordersArray = Object.values(orders).filter(o => o.status === 'completed'); 
                
                const revenueByDay = Array(30).fill(0); 
                const today = new Date();
                ordersArray.forEach(order => { 
                    const orderDate = new Date(order.timestamp); 
                    const diffDays = Math.floor((today - orderDate) / (1000*60*60*24)); 
                    if (diffDays >= 0 && diffDays < 30) {
                        revenueByDay[29-diffDays] += parseFloat(order.total_amount||0); 
                    }
                });
                const revenueLabels = Array(30).fill(0).map((_,i) => { 
                    const d=new Date(); 
                    d.setDate(d.getDate()-(29-i)); 
                    return d.toLocaleDateString('en-US',{month:'short',day:'numeric'}); 
                });
                const revenueCtx = document.getElementById('revenueByDayChart')?.getContext('2d');
                if (revenueCtx) {
                    if(revenueByDayChartInstance) revenueByDayChartInstance.destroy();
                    revenueByDayChartInstance = new Chart(revenueCtx, { 
                        type: 'bar', 
                        data: { 
                            labels: revenueLabels, 
                            datasets: [{ 
                                label: 'Daily Revenue (₹)', 
                                data: revenueByDay, 
                                backgroundColor: 'rgba(46,125,50,0.6)', 
                                borderColor: 'var(--th-primary)', 
                                borderWidth: 1 
                            }] 
                        }, 
                        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } } 
                    });
                }
                
                const itemCounts = {};
                ordersArray.forEach(order => { 
                    (order.items||[]).forEach(item => { 
                        itemCounts[item.name]=(itemCounts[item.name]||0)+(item.quantity||1); 
                    }); 
                });
                const sortedPopularItems = Object.entries(itemCounts).sort(([,a],[,b])=>b-a).slice(0,10); 
                const popularItemLabels = sortedPopularItems.map(([name])=>name); 
                const popularItemData = sortedPopularItems.map(([,count])=>count);
                const popularItemsCtx = document.getElementById('popularItemsChart')?.getContext('2d');
                if (popularItemsCtx) {
                    if(popularItemsChartInstance) popularItemsChartInstance.destroy();
                    popularItemsChartInstance = new Chart(popularItemsCtx, { 
                        type: 'doughnut', 
                        data: { 
                            labels: popularItemLabels, 
                            datasets: [{ 
                                label: 'Quantity Sold', 
                                data: popularItemData, 
                                backgroundColor: ['rgba(46,125,50,0.7)','rgba(255,143,0,0.7)','rgba(96,173,94,0.7)','rgba(255,169,64,0.7)','rgba(0,80,5,0.7)','rgba(197,110,0,0.7)','rgba(120,150,120,0.7)','rgba(200,150,100,0.7)','rgba(75,192,192,0.7)','rgba(153,102,255,0.7)'] 
                            }] 
                        }, 
                        options: { responsive: true, maintainAspectRatio: false } 
                    });
                }
            } catch (error) { 
                console.error("Error loading analytics data:", error); 
                showToast("Error loading analytics data.", "error"); 
            }
            showLoading(false);
        } 
        window.loadAnalyticsData = loadAnalyticsData;

    </script>
</body>
</html>
